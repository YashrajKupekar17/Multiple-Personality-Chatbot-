name: CD Pipeline
on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Start Minikube
        uses: medyagh/setup-minikube@latest
      
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f kubernetes/secrets.yaml
          kubectl apply -f kubernetes/api-deployment.yaml
          kubectl wait --for=condition=ready pod -l app=chatbot-api --timeout=180s
          kubectl apply -f kubernetes/ui-deployment.yaml
          kubectl wait --for=condition=ready pod -l app=chatbot-ui --timeout=180s
          kubectl get all
      
      - name: Health Check with Port Forwarding
        run: |
          # Port forward API in background
          kubectl port-forward service/chatbot-api 8000:8000 &
          API_PF_PID=$!
          
          # Port forward UI in background
          kubectl port-forward service/chatbot-ui 8501:8501 &
          UI_PF_PID=$!
          
          # Wait for port forwards to be ready
          sleep 5
          
          # Health check API
          for i in {1..10}; do
            if curl -f http://localhost:8000/health; then
              echo "✓ API is healthy"
              break
            fi
            echo "Waiting for API... (attempt $i)"
            sleep 3
          done
          
          # Health check UI
          for i in {1..10}; do
            if curl -f http://localhost:8501; then
              echo "✓ UI is healthy"
              break
            fi
            echo "Waiting for UI... (attempt $i)"
            sleep 3
          done
          
          # Clean up port forwards
          kill $API_PF_PID $UI_PF_PID || true
      
      - name: DAST Scan (OWASP ZAP)
        continue-on-error: true
        run: |
          # Port forward for ZAP scan
          kubectl port-forward service/chatbot-api 8000:8000 &
          PF_PID=$!
          sleep 5
          
          # Create directory for ZAP reports
          mkdir -p ${GITHUB_WORKSPACE}/zap-reports
          
          # Run ZAP scan with mounted volume for reports
          docker run --rm --network host \
            -v ${GITHUB_WORKSPACE}/zap-reports:/zap/wrk:rw \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py -t http://localhost:8000/health -r zap-report.html -I
          
          kill $PF_PID || true
          echo "DAST scan completed"
      
      - name: Upload ZAP Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-security-report
          path: zap-reports/zap-report.html
          retention-days: 30
      
      - name: Show Logs
        if: always()
        run: |
          echo "=== Deployments ==="
          kubectl get deployments
          echo "=== Pods ==="
          kubectl get pods
          echo "=== Services ==="
          kubectl get services
          echo "=== API Logs ==="
          kubectl logs -l app=chatbot-api --tail=50
          echo "=== UI Logs ==="
          kubectl logs -l app=chatbot-ui --tail=50