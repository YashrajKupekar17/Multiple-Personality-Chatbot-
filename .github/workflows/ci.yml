name: CI Pipeline
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-test:
    name: Build, Test & Secure
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      # Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install uv
        run: pip install uv

      # Install dependencies
      - name: Install API dependencies
        working-directory: chatbot-api
        run: uv sync --frozen

      - name: Install UI dependencies
        working-directory: chatbot-ui
        run: uv sync --frozen

      # Linting (Soft Gate)
      - name: Run API linting (ruff)
        working-directory: chatbot-api
        continue-on-error: true
        run: uv run ruff check .

      - name: Run UI linting (ruff)
        working-directory: chatbot-ui
        continue-on-error: true
        run: uv run ruff check .

      # SAST – CodeQL
      - name: Initialize CodeQL (Python)
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      # SCA – Dependency Scan (Soft Gate)
      - name: Dependency vulnerability scan (pip-audit)
        continue-on-error: true
        run: |
          pip install pip-audit
          pip-audit

      # Unit Tests
      - name: Run API tests
        working-directory: chatbot-api
        run: |
          if [ -d "tests" ]; then uv run pytest; else echo "No API tests found"; fi

      - name: Run UI tests
        working-directory: chatbot-ui
        run: echo "UI tests placeholder"

      # Docker Setup
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build Docker Images
      - name: Build API Docker image
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/chatbot-api:latest ./chatbot-api

      - name: Build UI Docker image
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/chatbot-ui:latest ./chatbot-ui

      # Trivy – Image Scan (Soft Gate - changed to exit-code: 0)
      - name: Run Trivy scan on API image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/chatbot-api:latest
          severity: CRITICAL,HIGH
          exit-code: 0
          vuln-type: library

      - name: Run Trivy scan on UI image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/chatbot-ui:latest
          severity: CRITICAL,HIGH
          exit-code: 0
          vuln-type: library

      # Create .env file for testing
      - name: Create test environment file
        working-directory: chatbot-api
        run: |
          cat > .env << EOF
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          MONGO_URI=${{ secrets.MONGO_URI }}
          MONGO_DB_NAME=MLAchatbot
          MONGO_STATE_CHECKPOINT_COLLECTION=checkpoints
          MONGO_STATE_WRITES_COLLECTION=checkpoints_writes_aio
          PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_NAME=${{ secrets.PINECONE_INDEX_NAME }}
          EOF

      # Runtime Container Tests using Docker Compose
      - name: Test with Docker Compose
        run: |
          echo "Starting services with Docker Compose..."
          docker compose up -d
          
          echo "Waiting for API to be ready..."
          for i in {1..30}; do
            if curl -f http://localhost:8000/health 2>/dev/null; then
              echo "✓ API is healthy!"
              break
            fi
            echo "Attempt $i/30: API not ready yet..."
            sleep 2
          done
          
          echo "Waiting for UI to be ready..."
          for i in {1..30}; do
            if curl -f http://localhost:8501 2>/dev/null; then
              echo "✓ UI is healthy!"
              break
            fi
            echo "Attempt $i/30: UI not ready yet..."
            sleep 2
          done
          
          echo "=== API Logs ==="
          docker compose logs api
          
          echo "=== UI Logs ==="
          docker compose logs ui
          
          # Final health checks
          echo "Running final health checks..."
          curl -f http://localhost:8000/health || (echo "API health check failed" && docker compose logs api && exit 1)
          curl -f http://localhost:8501 || (echo "UI health check failed" && docker compose logs ui && exit 1)
          
          echo "✓ All services are running successfully!"
          
          # Cleanup
          docker compose down

      # Login to DockerHub
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Push Images
      - name: Push API image
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/chatbot-api:latest

      - name: Push UI image
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/chatbot-ui:latest